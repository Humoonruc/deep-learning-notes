<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>二元 Loss Function</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"></script>
</head>

<body>
  <h2 id="h2">含有常数项的二元 Loss Function, BGD 优化</h2>
  <p>BGD优化方法的统计量与x无关而只与w, b有关，只有这样才能画出损失函数的三维截面图。</p>
  <div id="plot" style="width:60%;height:500px;"></div>
  <script type="module">

    import { renderPoints } from '../src/renderRandomData.js';

    // config
    const scale = 1000;
    const alpha = 0.03;


    // data
    const points = renderPoints(scale);
    const sumXX = d3.sum(points.map(p => p.x ** 2))
    const sumYY = d3.sum(points.map(p => p.y ** 2))
    const sumXY = d3.sum(points.map(p => p.x * p.y))
    const sumX = d3.sum(points.map(p => p.x))
    const sumY = d3.sum(points.map(p => p.y))


    // lost function 的截面
    const ws = d3.range(0, 3, 0.05) // w 遍历 30 个点
    const bs = d3.range(-2, 2, 0.05) // b 遍历 40 个点

    let x3D = []
    let y3D = []
    let z3D = []

    for (let w of ws) {
      for (let b of bs) {
        const es = points.map(p => w * p.x + b - p.y)
        const S = d3.sum(es.map(e => e ** 2)) / scale
        x3D.push(w)
        y3D.push(b)
        z3D.push(S)
      }
    }
    const possibleSpace = {
      name: '参数空间',
      type: "mesh3d",
      opacity: 0.4,
      x: x3D,
      y: y3D,
      z: z3D,
      marker: {
        color: 'royalblue',
        size: 0.5
      }
    }


    let w = 0.1
    let b = 1.5
    const es = points.map(p => w * p.x + b - p.y)
    const S = d3.sum(es.map(e => e ** 2)) / scale
    let searchMin = {
      name: '参数调优',
      type: 'scatter3d',
      x: [w],
      y: [b],
      z: [S],
      marker: {
        color: 'red',
        size: 5,
      }
    }


    // 绘图
    const data = [possibleSpace, searchMin];
    const layout = {
      title: {
        text: `模型参数为：w = ${d3.format(".3f")(w)}, b = ${d3.format(".3f")(b)}`,
        font: {
          family: 'Droid Sans Mono',
          size: 20,
        },
        xref: 'paper',
        x: 0,
      },
      showlegend: true,
      legend: {
        // bgcolor: 'yellow',
        font: {
          color: 'black',
          size: 14,
        },
      },
      scene: {
        aspectmode: "manual",
        aspectratio: {
          x: 1, y: 0.7, z: 1,
        },
        xaxis: {
          title: {
            text: 'w',
            font: {
              size: 16,
            }
          },
        },
        yaxis: {
          title: {
            text: 'b',
            font: {
              size: 16,
            }
          },
        },
        zaxis: {
          title: {
            text: 'Statistics',
            font: {
              size: 16,
            }
          },
        }
      },
    };
    const plotDiv = document.querySelector('div#plot');
    Plotly.newPlot(plotDiv, data, layout);


    // BGD Adjust，每次迭代重新计算 w 和 b 后，更新图像

    for (let m = 0; m < 3; m++) {

      let count = 0;

      points.forEach(p => {
        w += -(2 / scale) * (sumXX * w - sumXY + b * sumX) * alpha;
        b += -(2 / scale) * (scale * b + sumX * w - sumY) * alpha
        const es = points.map(p => w * p.x + b - p.y)
        const S = d3.sum(es.map(e => e ** 2)) / scale

        count++;

        if ((m === 0 && count < 500 && count % 10 === 0) || (m === 0 && count >= 500 && count % 50 === 0) || (m > 0 && count % 100 === 0)) {
          searchMin = {
            data: [{
              x: [w],
              y: [b],
              z: [S],
            }],
            traces: [1],
            layout: {
              title: {
                text: `第${m + 1}轮学习第${count}次迭代……模型参数：w = ${d3.format(".3f")(w)}, b = ${d3.format(".3f")(b)}`,
              },
            },
          };
          Plotly.animate(plotDiv, searchMin, {
            transition: {
              duration: 10,
              easing: 'cubic-in-out'
            },
            frame: {
              duration: 10
            }
          })
        }
      })

    }

  </script>
</body>

</html>