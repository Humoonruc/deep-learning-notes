<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rosenblatt 感知机 迭代过程可视化</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"></script>
</head>

<body>
  <h2>Rosenblatt 感知机 SGD 迭代过程可视化</h2>
  <div id="plot" style="width:60%;height:500px;"></div>
  <script type="module">
    import { renderPoints } from '../src/renderRandomData.js';


    // config
    const scale = 1000;
    const alpha = 0.03;
    let w = 0.5; // 定义模型参数的初始值


    // data
    const points = renderPoints(scale);
    const xs = points.map(p => p.x)
    const ys = points.map(p => p.y);
    let ysPre = xs.map(x => x * w);


    // 绘图
    const plotDiv = document.querySelector('div#plot');
    const trainingSet = {
      x: xs,
      y: ys,
      name: '训练集',
      mode: 'markers',
      marker: {
        color: 'black',
        size: 1.5
      }
    };
    let fittingModel = {
      x: xs,
      y: ysPre,
      name: '拟合模型',
      mode: 'lines+markers',
      marker: {
        color: 'red',
        size: 2
      }
    };
    const dataSet = [trainingSet, fittingModel];
    const layout = {
      title: {
        text: `拟合模型为：y=${d3.format(".4f")(w)}x`,
        font: {
          family: 'Droid Sans Mono',
          size: 18,
        },
        xref: 'paper',
        x: 0,
      },
      legend: {
        bgcolor: 'yellow',
        font: {
          color: 'black',
          size: 14,
        },
      },
      margin: {
        t: 60,
        b: 40,
        pad: 10
      },
      paper_bgcolor: 'lightgrey',
      plot_bgcolor: 'white',
      xaxis: {
        tickfont: {
          family: 'Consolas',
          size: 16,
        }
      },
      yaxis: {
        tickfont: {
          family: 'Consolas',
          size: 16,
        }
      }
    };
    Plotly.newPlot(plotDiv, dataSet, layout);


    // SGD Adjust
    let count = 0
    for (let m = 0; m < 5; m++) {
      points.forEach(p => {
        const e = p.y - w * p.x;
        w += e * alpha;
        ysPre = xs.map(x => x * w);

        count++;

        if (count % 10 === 0) {
          fittingModel = {
            data: [{ x: xs, y: ysPre, }],
            traces: [1],
            layout: {
              title: {
                text: `拟合模型为：y=${d3.format(".4f")(w)}x`,
              },
            },
          };

          Plotly.animate(plotDiv, fittingModel, {
            transition: {
              duration: 1,
              easing: 'cubic-in-out'
            },
            frame: {
              duration: 1
            }
          })
        }
      });
    }

  </script>
</body>

</html>