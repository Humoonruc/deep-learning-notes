<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activation Function</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js"></script>
</head>

<body>
  <h2 id="h2">sigmoid 激活函数, SGD 优化</h2>
  <div id="plot" style="width:60%;height:500px;"></div>
  <script type="module">

    // config
    const scale = 100;
    const alpha = 0.2;
    let w = 0.1
    let b = 0.1
    function sigmoid(x) {
      return (1 / (1 + Math.exp(-x)))
    }

    // data
    function renderPoints(scale) {
      const points = [...Array(scale)]
        .map(ele => {
          const x = Math.random();
          const t = 0.7 * x + 0.51 - Math.random() / 50;
          const y = t > 0.8 ? 1 : 0;
          return { x: x, y: y };
        })
        .sort((a, b) => a.x - b.x);

      return points;
    };

    const points = renderPoints(scale);
    const xs = points.map(p => p.x)
    const ys = points.map(p => p.y)
    const ysPre = xs.map(x => sigmoid(w * x + b))


    // 绘图
    const plotDiv = document.querySelector('div#plot');
    const trainingSet = {
      x: xs,
      y: ys,
      name: '训练集',
      mode: 'markers',
      marker: {
        color: 'black',
        size: 2
      }
    };
    let fittingModel = {
      x: xs,
      y: ysPre,
      name: '拟合模型',
      mode: 'lines+markers',
      marker: {
        color: 'red',
        size: 2
      }
    };
    const dataSet = [trainingSet, fittingModel];
    const layout = {
      title: {
        text: `拟合模型为：y=${d3.format(".4f")(w)}x`,
        font: {
          family: 'Droid Sans Mono',
          size: 18,
        },
        xref: 'paper',
        x: 0,
      },
      legend: {
        bgcolor: 'yellow',
        font: {
          color: 'black',
          size: 14,
        },
      },
      margin: {
        t: 60,
        b: 40,
        pad: 10
      },
      paper_bgcolor: 'lightgrey',
      plot_bgcolor: 'white',
      xaxis: {
        tickfont: {
          family: 'Consolas',
          size: 16,
        }
      },
      yaxis: {
        tickfont: {
          family: 'Consolas',
          size: 16,
        }
      }
    };
    Plotly.newPlot(plotDiv, dataSet, layout);


    // SGD Adjust

    for (let m = 0; m < 30000; m++) {
      let count = 0

      points.forEach(p => {
        count++;

        // 引入 sigmoid 激活函数后，模型变为 yPre = sigmoid(w*x+b)
        // 于是 e = y-sigmoid(w*x+b), E = e**2 （用SGD优化，不必使用所有样本）
        // 用复合函数求导法则，于是有

        let z = w * p.x + b
        let a = sigmoid(z)
        let E = (p.y - a) ** 2

        let dEda = -2 * (p.y - a)
        let dadz = a * (1 - a)
        let dzdw = p.x
        let dzdb = 1
        let dEdw = dEda * dadz * dzdw
        let dEdb = dEda * dadz * dzdb

        w -= dEdw * alpha
        b -= dEdb * alpha

        const ysPre = xs.map(x => sigmoid(w * x + b))

        if ((m+1) % 200 === 0 && count % 100 === 0) {

          fittingModel = {
            data: [{ x: xs, y: ysPre, }],
            traces: [1],
            layout: {
              title: {
                text: `第${m + 1}轮第${count}次迭代，拟合模型为：y=sigmoid(${d3.format(".4f")(w)}x${d3.format(".4f")(b)})`,
              },
            },
          };

          Plotly.animate(plotDiv, fittingModel, {
            transition: {
              duration: 1,
              easing: 'cubic-in-out'
            },
            frame: {
              duration: 1
            }
          })

        }


      });
    }



  </script>
</body>

</html>